// --- å®šæ•°ã¨çŠ¶æ…‹å¤‰æ•° ---
const MAX_G = 9.80665; 
const MAX_DISPLACEMENT = 125; 
const FILTER_ALPHA = 0.2; 
const DECLINE_THRESHOLD = 0.3; 
const SLIP_PEAK_MIN = 0.4; 
const COOLDOWN_MS = 3000; 
const HISTORY_SIZE = 12; 
const TRACE_DURATION_MS = 1000; 
const TRACE_INTERVAL_MS = 50;   

const MAX_G_SCALE = 0.7; 

let initialGravity = { x: 0, y: 0, z: 0 }; 
let isInitialized = false;
// ã€ä¿®æ­£ã€‘Max Gå¤‰æ•°ã‚’4åˆ†å‰²
let maxG_left = 0;
let maxG_right = 0;
let maxG_front = 0;
let maxG_rear = 0;

let lastWarningTime = 0;
let accelerationHistory = [];
let currentOrientation = 0; 
let filteredPosition = { x: 0, y: 0 }; 

let traceHistory = []; 
let lastTraceTime = 0;

// --- DOMè¦ç´  ---
const ball = document.getElementById('ball');
const traceContainer = document.getElementById('ball-trace-container'); 
const statusText = document.getElementById('status-text');
// ã€ä¿®æ­£ã€‘Max Gè¡¨ç¤ºDOMè¦ç´ ã‚’4åˆ†å‰²
const maxGLeftDisplay = document.getElementById('max-g-left');
const maxGRightDisplay = document.getElementById('max-g-right');
const maxGFrontDisplay = document.getElementById('max-g-front');
const maxGRearDisplay = document.getElementById('max-g-rear');

const initButton = document.getElementById('request-permission');
const resetButton = document.getElementById('reset-max');

// ... (setupAudio, playWarningSound, requestSensorPermission, setupListeners, updateOrientation, initializeZeroPoint ã¯çœç•¥) ...

function setupAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); 
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        gainNode.gain.setValueAtTime(0, audioContext.currentTime); 
    } catch (e) {
        console.error("Audio Contextã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
        statusText.textContent = 'è­¦å‘ŠéŸ³æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™ã€‚';
    }
}
function playWarningSound() {
    if (!gainNode || !audioContext) return;
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.3);
}
function requestSensorPermission() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
                if (permissionState === 'granted') {
                    setupListeners();
                } else {
                    statusText.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦';
                }
            })
            .catch(error => {
                statusText.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error;
                console.error(error);
            });
    } else {
        setupListeners();
    }
}
function setupListeners() {
    setupAudio();
    window.addEventListener('devicemotion', handleMotion);
    window.addEventListener('orientationchange', updateOrientation);
    currentOrientation = window.orientation || 0;
    statusText.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯æ¸ˆ';
}
function updateOrientation() {
    currentOrientation = window.orientation || 0;
    if (isInitialized) {
        statusText.textContent = 'å‘ããŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚å†åº¦åˆæœŸåŒ–ã—ã¦ãã ã•ã„ã€‚';
        isInitialized = false;
    }
}
function initializeZeroPoint(event) {
    if (!event || !event.accelerationIncludingGravity) {
        statusText.textContent = 'åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸å¯';
        return;
    }
    currentOrientation = window.orientation || 0;
    const { x, y, z } = event.accelerationIncludingGravity;
    initialGravity.x = x;
    initialGravity.y = y;
    initialGravity.z = z; 
    isInitialized = true;
    // ã€ä¿®æ­£ã€‘Max Gå¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
    maxG_left = 0;
    maxG_right = 0;
    maxG_front = 0;
    maxG_rear = 0;
    accelerationHistory = [];
    filteredPosition = { x: 0, y: 0 }; 
    traceHistory = []; 
    traceContainer.innerHTML = ''; 
    statusText.textContent = 'åˆæœŸåŒ–å®Œäº† (Gè¨ˆæ¸¬ä¸­)';
    updateDisplay();
}

// --- ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---
function handleMotion(event) {
    const { accelerationIncludingGravity } = event;
    const currentTime = Date.now(); 

    if (!accelerationIncludingGravity) return;
    if (!isInitialized) {
        initializeZeroPoint(event);
        return;
    }

    // 1. é‡åŠ›æˆåˆ†ã®é™¤åŽ»
    let userAccelY = accelerationIncludingGravity.y - initialGravity.y;
    let userAccelZ = accelerationIncludingGravity.z - initialGravity.z;
    
    // 2. è»¸ãƒžãƒƒãƒ”ãƒ³ã‚°
    // Xè»¸: å·¦å³ (å·¦ãŒãƒ—ãƒ©ã‚¹, å³ãŒãƒžã‚¤ãƒŠã‚¹) 
    // Yè»¸: å‰å¾Œ (å‰ãŒãƒ—ãƒ©ã‚¹, å¾ŒãŒãƒžã‚¤ãƒŠã‚¹)
    let accelX_car; // å·¦å³ (X:ãƒ¨ãƒ¼)
    let accelY_car; // å‰å¾Œ (Y:ãƒ”ãƒƒãƒ)
    
    if (currentOrientation === 90) { 
        accelY_car = -userAccelZ; 
        accelX_car = -userAccelY; 
    } else if (currentOrientation === -90) { 
        accelY_car = -userAccelZ;
        accelX_car = userAccelY; 
    } else { 
        return;
    }
    
    // 3. Gè¨ˆç®—ã€4. è­¦å‘Š
    const MAX_G_CONST = MAX_G; 
    const accelMagnitudeG = Math.sqrt(accelX_car * accelX_car + accelY_car * accelY_car) / MAX_G_CONST;
    updateHistory(accelMagnitudeG);
    checkAndTriggerSlipWarning(accelMagnitudeG);

    // 5. ã€ä¿®æ­£ã€‘æœ€å¤§åŠ é€Ÿåº¦ã®æ›´æ–°ã‚’4æ–¹å‘ã«åˆ†å‰²
    const gX = accelX_car / MAX_G_CONST; // å·¦å³ (-1.0 ~ 1.0)
    const gY = accelY_car / MAX_G_CONST; // å‰å¾Œ (-1.0 ~ 1.0)
    
    // Xè»¸: å·¦ãŒãƒ—ãƒ©ã‚¹, å³ãŒãƒžã‚¤ãƒŠã‚¹
    if (gX > 0 && gX > maxG_left) maxG_left = gX;
    if (gX < 0 && Math.abs(gX) > maxG_right) maxG_right = Math.abs(gX);
    
    // Yè»¸: å‰ãŒãƒ—ãƒ©ã‚¹, å¾ŒãŒãƒžã‚¤ãƒŠã‚¹
    if (gY > 0 && gY > maxG_front) maxG_front = gY;
    if (gY < 0 && Math.abs(gY) > maxG_rear) maxG_rear = Math.abs(gY);


    // 6. ç”Ÿã®ãƒœãƒ¼ãƒ«ä½ç½®ã®è¨ˆç®—
    const normalizedX = accelX_car / MAX_G_CONST; 
    const normalizedY = accelY_car / MAX_G_CONST; 
    
    // ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã‚’é©ç”¨: 0.7Gã§ãƒ¡ãƒ¼ã‚¿ãƒ¼ç«¯ã«åˆ°é”ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
    const rawOffsetX = (normalizedX / MAX_G_SCALE) * MAX_DISPLACEMENT; 
    const rawOffsetY = -(normalizedY / MAX_G_SCALE) * MAX_DISPLACEMENT; // Yè»¸ã¯åè»¢

    // 7. æŒ‡æ•°ç§»å‹•å¹³å‡ (EMA) ãƒ•ã‚£ãƒ«ã‚¿ã®é©ç”¨
    filteredPosition.x = (FILTER_ALPHA * rawOffsetX) + ((1 - FILTER_ALPHA) * filteredPosition.x);
    filteredPosition.y = (FILTER_ALPHA * rawOffsetY) + ((1 - FILTER_ALPHA) * filteredPosition.y);


    // 8. åˆæˆGãŒMAX_DISPLACEMENT (0.7G) ã‚’è¶…ãˆãªã„ã‚ˆã†ã«åˆ¶é™
    let clipX = filteredPosition.x;
    let clipY = filteredPosition.y;
    
    const currentDistance = Math.sqrt(clipX * clipX + clipY * clipY);

    if (currentDistance > MAX_DISPLACEMENT) {
        const scaleFactor = MAX_DISPLACEMENT / currentDistance;
        clipX *= scaleFactor;
        clipY *= scaleFactor;
    }

    // 9. UIæ›´æ–°
    ball.style.transform = `translate(calc(-50% + ${clipX}px), calc(-50% + ${clipY}px))`;
    updateDisplay();
    
    // 10. æ®‹åƒã®è¨˜éŒ²ã¨æç”»ãƒ­ã‚¸ãƒƒã‚¯
    updateTrace(clipX, clipY, currentTime);
}


// --- æ®‹åƒã®ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ ---

function updateTrace(x, y, currentTime) {
    // 1. å¤ã„æ®‹åƒã®å‰Šé™¤ã¨ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
    while (traceHistory.length > 0 && currentTime - traceHistory[0].time > TRACE_DURATION_MS + 100) {
        const oldDot = traceHistory.shift();
        if (oldDot.element) {
            oldDot.element.remove();
        }
    }

    // 2. æ®‹åƒã®è¨˜éŒ²ã¨æ–°ã—ã„DOMè¦ç´ ã®ç”Ÿæˆ
    if (currentTime - lastTraceTime > TRACE_INTERVAL_MS) {
        const traceDot = document.createElement('div');
        traceDot.className = 'trace-dot';
        traceDot.style.transform = `translate(calc(125px + ${x}px), calc(125px + ${y}px))`;
        
        traceContainer.appendChild(traceDot);

        traceHistory.push({ x, y, time: currentTime, element: traceDot });
        lastTraceTime = currentTime;
        
        // 3. ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é–‹å§‹ã•ã›ã‚‹
        requestAnimationFrame(() => {
            traceHistory.forEach(dot => {
                if (currentTime - dot.time > 0) {
                    dot.element.style.opacity = '0';
                }
            });
        });
    }
}

// --- GæŠœã‘åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
function updateHistory(currentMagnitude) {
    accelerationHistory.push(currentMagnitude);
    if (accelerationHistory.length > HISTORY_SIZE) {
        accelerationHistory.shift();
    }
}
function checkAndTriggerSlipWarning(currentMagnitude) {
    if (accelerationHistory.length !== HISTORY_SIZE) return;
    const peakMagnitude = Math.max(...accelerationHistory);
    const decline = peakMagnitude - currentMagnitude;
    const currentTime = Date.now();
    if (decline >= DECLINE_THRESHOLD && peakMagnitude >= SLIP_PEAK_MIN && (currentTime - lastWarningTime) > COOLDOWN_MS) {
        playWarningSound();
        lastWarningTime = currentTime;
        console.log(`ðŸš¨ GæŠœã‘è­¦å‘Šï¼ ãƒ”ãƒ¼ã‚¯: ${peakMagnitude.toFixed(2)} G -> ç¾åœ¨: ${currentMagnitude.toFixed(2)} G`);
    }
}

// --- UIæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ---
function updateDisplay() {
    // ã€ä¿®æ­£ã€‘4ã¤ã®è¡¨ç¤ºã‚’æ›´æ–°
    maxGLeftDisplay.textContent = maxG_left.toFixed(2);
    maxGRightDisplay.textContent = maxG_right.toFixed(2);
    maxGFrontDisplay.textContent = maxG_front.toFixed(2);
    maxGRearDisplay.textContent = maxG_rear.toFixed(2);
}
function resetMaxG() {
    // ã€ä¿®æ­£ã€‘4ã¤ã®å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
    maxG_left = 0;
    maxG_right = 0;
    maxG_front = 0;
    maxG_rear = 0;
    updateDisplay();
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²
window.onload = () => {
    initButton.addEventListener('click', requestSensorPermission);
    resetButton.addEventListener('click', resetMaxG);
    
    if (typeof DeviceOrientationEvent.requestPermission !== 'function') {
        requestSensorPermission();
    }
    
    updateOrientation();
};
